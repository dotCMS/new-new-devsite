name: Flush CDN After Merge

on:
  push:
    branches: [ main,testing ]

  workflow_dispatch:
    

jobs:
  flush-cdn-after-merge:
    runs-on: ubuntu-latest
    
    steps:

    - name: Flush CDN after merge
      env:
        NEXT_PUBLIC_DOTCMS_HOST: ${{ secrets.BUNNY_PULLZONE_ID }}
        NEXT_PUBLIC_AUTH_TOKEN: ${{ secrets.BUNNY_ACCESS_KEY }}
      run: |
        sleep 90 # Wait for the CDN to be updated
        curl --request POST \
            --url https://api.bunny.net/pullzone/${{ secrets.BUNNY_PULLZONE_ID }}/purgeCache \
            --header "AccessKey: ${{ secrets.BUNNY_ACCESS_KEY }}" \
            --header 'content-type: application/json'
        sleep 60 # Wait for the CDN to be updated
        curl --request POST \
            --url https://api.bunny.net/pullzone/${{ secrets.BUNNY_PULLZONE_ID }}/purgeCache \
            --header "AccessKey: ${{ secrets.BUNNY_ACCESS_KEY }}" \
            --header 'content-type: application/json'

        




# Purging the CDN curl command
# curl --request POST \
#     --url https://api.bunny.net/pullzone/${{ secrets.BUNNY_PULLZONE_ID }}/purgeCache \
#     --header 'AccessKey: ${{ secrets.BUNNY_ACCESS_KEY }}' \
#     --header 'content-type: application/json'
#
